<div class="anomalies-container">
  <!-- En-tête avec statistiques -->
  <div class="anomalies-header">
    <h1>GESTION DES ANOMALIES</h1>
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-number">{{ stats.total }}</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-card detected">
        <div class="stat-number">{{ stats.detected }}</div>
        <div class="stat-label">Détectées</div>
      </div>
      <div class="stat-card in-progress">
        <div class="stat-number">{{ stats.inProgress }}</div>
        <div class="stat-label">En cours</div>
      </div>
      <div class="stat-card resolved">
        <div class="stat-number">{{ stats.resolved }}</div>
        <div class="stat-label">Résolues</div>
      </div>
      <div class="stat-card critical">
        <div class="stat-number">{{ stats.critical }}</div>
        <div class="stat-label">Critiques</div>
      </div>
    </div>
  </div>

  <!-- Graphique de répartition -->
  <div class="chart-section">
    <div class="chart-card">
      <h3>Répartition par type</h3>
      <div class="chart-container">
        <p-chart
          type="doughnut"
          [data]="chartData"
          [options]="chartOptions"
        ></p-chart>
      </div>
    </div>
  </div>

  <!-- Barre de filtres -->
  <div class="filters-section">
    <div class="search-bar">
      <i class="pi pi-search"></i>
      <input
        type="text"
        pInputText
        [(ngModel)]="searchText"
        (input)="onSearchChange()"
        placeholder="Rechercher une anomalie..."
        class="search-input"
      />
    </div>

    <div class="filter-controls">
      <p-dropdown
        [options]="statusOptions"
        [(ngModel)]="filter.status"
        (onChange)="onFilterChange()"
        placeholder="Statut"
        class="filter-dropdown"
      >
      </p-dropdown>

      <p-dropdown
        [options]="severityOptions"
        [(ngModel)]="filter.severity"
        (onChange)="onFilterChange()"
        placeholder="Sévérité"
        class="filter-dropdown"
      >
      </p-dropdown>

      <p-dropdown
        [options]="typeOptions"
        [(ngModel)]="filter.type"
        (onChange)="onFilterChange()"
        placeholder="Type"
        class="filter-dropdown"
      >
      </p-dropdown>

      <p-calendar
        [(ngModel)]="filter.dateRange"
        (onSelect)="onFilterChange()"
        selectionMode="range"
        placeholder="Période"
        class="filter-calendar"
      >
      </p-calendar>

      <button
        pButton
        type="button"
        label="Effacer"
        icon="pi pi-times"
        (click)="clearFilters()"
        class="clear-button"
      ></button>
    </div>
  </div>

  <!-- Tableau des anomalies -->
  <div class="anomalies-table-container">
    <p-table
      [value]="filteredAnomalies"
      [loading]="loading"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} anomalies"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="anomalies-table"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <i class="pi pi-exclamation-triangle"></i>
          </th>
          <th pSortableColumn="title">
            Titre <p-sortIcon field="title"></p-sortIcon>
          </th>
          <th pSortableColumn="severity">
            Sévérité <p-sortIcon field="severity"></p-sortIcon>
          </th>
          <th pSortableColumn="status">
            Statut <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th pSortableColumn="type">
            Type <p-sortIcon field="type"></p-sortIcon>
          </th>
          <th pSortableColumn="user_name">
            Utilisateur <p-sortIcon field="user_name"></p-sortIcon>
          </th>
          <th pSortableColumn="detected_at">
            Détectée le <p-sortIcon field="detected_at"></p-sortIcon>
          </th>
          <th style="width: 8rem">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-anomaly>
        <tr [class.critical-row]="anomaly.severity === 'critical'">
          <td>
            <i
              class="pi pi-exclamation-triangle"
              [class.text-danger]="anomaly.severity === 'critical'"
              [class.text-warning]="anomaly.severity === 'major'"
              [class.text-info]="anomaly.severity === 'minor'"
              [class.text-success]="anomaly.severity === 'info'"
            >
            </i>
          </td>
          <td>
            <div class="anomaly-title" (click)="viewAnomaly(anomaly)">
              {{ anomaly.title }}
            </div>
            <div class="anomaly-description">
              {{ anomaly.description | slice : 0 : 50
              }}{{ anomaly.description.length > 50 ? "..." : "" }}
            </div>
          </td>
          <td>
            <p-tag
              [value]="getSeverityLabel(anomaly.severity)"
              [severity]="getSeverity(anomaly.severity)"
            >
            </p-tag>
          </td>
          <td>
            <p-tag
              [value]="getStatusLabel(anomaly.status)"
              [severity]="getStatusSeverity(anomaly.status)"
            >
            </p-tag>
          </td>
          <td>
            <span class="anomaly-type">{{ getTypeLabel(anomaly.type) }}</span>
          </td>
          <td>
            <div class="user-info">
              <div class="user-name">{{ anomaly.user_name || "N/A" }}</div>
              <div class="user-service">{{ anomaly.service_name || "" }}</div>
            </div>
          </td>
          <td>
            <span class="anomaly-date">{{
              formatDate(anomaly.detected_at)
            }}</span>
          </td>
          <td>
            <div class="action-buttons">
              <button
                pButton
                type="button"
                icon="pi pi-eye"
                class="p-button-sm p-button-text"
                (click)="viewAnomaly(anomaly)"
                pTooltip="Voir les détails"
              ></button>
              <button
                pButton
                type="button"
                icon="pi pi-check"
                class="p-button-sm p-button-success p-button-text"
                (click)="takeAction(anomaly, 'resolve')"
                pTooltip="Résoudre"
                [disabled]="anomaly.status === 'resolved'"
              ></button>
              <button
                pButton
                type="button"
                icon="pi pi-arrow-up"
                class="p-button-sm p-button-warning p-button-text"
                (click)="takeAction(anomaly, 'escalate')"
                pTooltip="Escalader"
                [disabled]="anomaly.status === 'escalated'"
              ></button>
              <button
                pButton
                type="button"
                icon="pi pi-times"
                class="p-button-sm p-button-danger p-button-text"
                (click)="takeAction(anomaly, 'dismiss')"
                pTooltip="Ignorer"
                [disabled]="anomaly.status === 'dismissed'"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center">
            <div class="empty-state">
              <i
                class="pi pi-check-circle"
                style="font-size: 3rem; color: #28a745"
              ></i>
              <h3>Aucune anomalie trouvée</h3>
              <p>Aucune anomalie ne correspond aux critères de recherche.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Dialog de détails d'anomalie -->
  <p-dialog
    header="Détails de l'anomalie"
    [(visible)]="showAnomalyDialog"
    [modal]="true"
    [style]="{ width: '50vw' }"
    [closable]="true"
  >
    <div *ngIf="selectedAnomaly" class="anomaly-details">
      <div class="detail-section">
        <h4>{{ selectedAnomaly.title }}</h4>
        <p class="anomaly-description-full">
          {{ selectedAnomaly.description }}
        </p>
      </div>

      <div class="detail-grid">
        <div class="detail-item">
          <label>Sévérité:</label>
          <p-tag
            [value]="getSeverityLabel(selectedAnomaly.severity)"
            [severity]="getSeverity(selectedAnomaly.severity)"
          >
          </p-tag>
        </div>

        <div class="detail-item">
          <label>Statut:</label>
          <p-tag
            [value]="getStatusLabel(selectedAnomaly.status)"
            [severity]="getStatusSeverity(selectedAnomaly.status)"
          >
          </p-tag>
        </div>

        <div class="detail-item">
          <label>Type:</label>
          <span>{{ getTypeLabel(selectedAnomaly.type) }}</span>
        </div>

        <div class="detail-item">
          <label>Utilisateur:</label>
          <span>{{ selectedAnomaly.user_name || "N/A" }}</span>
        </div>

        <div class="detail-item">
          <label>Service:</label>
          <span>{{ selectedAnomaly.service_name || "N/A" }}</span>
        </div>

        <div class="detail-item">
          <label>Détectée le:</label>
          <span>{{ formatDate(selectedAnomaly.detected_at) }}</span>
        </div>

        <div class="detail-item" *ngIf="selectedAnomaly.resolved_at">
          <label>Résolue le:</label>
          <span>{{ formatDate(selectedAnomaly.resolved_at) }}</span>
        </div>

        <div class="detail-item" *ngIf="selectedAnomaly.resolved_by">
          <label>Résolue par:</label>
          <span>{{ selectedAnomaly.resolved_by }}</span>
        </div>

        <div class="detail-item" *ngIf="selectedAnomaly.comment">
          <label>Commentaire:</label>
          <span>{{ selectedAnomaly.comment }}</span>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Fermer"
        icon="pi pi-times"
        (click)="showAnomalyDialog = false"
        class="p-button-text"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Dialog d'action -->
  <p-dialog
    [header]="
      'Action: ' +
      (actionType === 'resolve'
        ? 'Résoudre'
        : actionType === 'escalate'
        ? 'Escalader'
        : 'Ignorer')
    "
    [(visible)]="showActionDialog"
    [modal]="true"
    [style]="{ width: '40vw' }"
    [closable]="true"
  >
    <div class="action-form">
      <div class="form-group">
        <label for="actionComment">Commentaire:</label>
        <textarea
          id="actionComment"
          pTextarea
          [(ngModel)]="actionComment"
          rows="4"
          placeholder="Ajoutez un commentaire pour cette action..."
        >
        </textarea>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button
        pButton
        type="button"
        label="Annuler"
        icon="pi pi-times"
        (click)="showActionDialog = false"
        class="p-button-text"
      ></button>
      <button
        pButton
        type="button"
        [label]="
          actionType === 'resolve'
            ? 'Résoudre'
            : actionType === 'escalate'
            ? 'Escalader'
            : 'Ignorer'
        "
        [icon]="
          actionType === 'resolve'
            ? 'pi pi-check'
            : actionType === 'escalate'
            ? 'pi pi-arrow-up'
            : 'pi pi-times'
        "
        [class]="
          actionType === 'resolve'
            ? 'p-button-success'
            : actionType === 'escalate'
            ? 'p-button-warning'
            : 'p-button-danger'
        "
        (click)="confirmAction()"
      ></button>
    </ng-template>
  </p-dialog>

  <p-toast></p-toast>
</div>












