<div class="dashboard-container p-4 md:p-6">
  <p-toast></p-toast>
  <p class="dashboard-title text-2xl md:text-3xl font-bold mb-6">GESTIONS DES COMPTES</p>

  <div class="flex justify-end py-5">
    <p-button (click)="openCreateUser()" severity="contrast">Ajouter Comptes</p-button>
  </div>

  <div class="flex flex-col md:flex-row gap-4 mb-6">
    <div class="flex-1">
      <span class="p-input-icon-left w-full">
        <input pInputText type="text" [(ngModel)]="searchTerm" 
               (input)="applyFilter()" 
               placeholder="Rechercher par nom, prénom, email, téléphone, rôle ou service..."
               class="w-full border border-gray-300 rounded-md focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors h-11">
      </span>
    </div>
    <div>
      <p-select [options]="roleOptions" [(ngModel)]="selectedRole" (onChange)="onRoleFilterChange()"
                placeholder="Filtrer par rôle" class="w-full md:w-56 uniform-input"/>
    </div>
  </div>

  <p-drawer [visible]="drawerVisible()" (visibleChange)="drawerVisible.set($event)" position="right" [header]="isEditMode ? 'Modifier ce compte' : 'Ajouter un compte'">
    <div class="flex flex-col gap-2" [formGroup]="userForm">
      <p-iftalabel>
        <input pInputText id="first_name" formControlName="first_name" autocomplete="off" class="uniform-input"/>
        <label for="first_name">Nom *</label>
        <small *ngIf="userForm.get('first_name')?.touched && userForm.get('first_name')?.invalid" class="text-red-500">
          Le nom est requis (min. 3 caractères).
        </small>
      </p-iftalabel>
      <div class="h-2"></div>

      <p-iftalabel>
        <input pInputText id="last_name" formControlName="last_name" autocomplete="off" class="uniform-input"/>
        <label for="last_name">Prénom *</label>
        <small *ngIf="userForm.get('last_name')?.touched && userForm.get('last_name')?.invalid" class="text-red-500">
          Le prénom est requis (min. 3 caractères).
        </small>
      </p-iftalabel>
      <div class="h-2"></div>

      <p-iftalabel>
        <input pInputText id="tel" formControlName="tel" autocomplete="off" class="uniform-input"/>
        <label for="tel">Numéro *</label>
        <small *ngIf="userForm.get('tel')?.touched && userForm.get('tel')?.invalid" class="text-red-500">
          Numéro invalide (10 chiffres requis).
        </small>
      </p-iftalabel>
      <div class="h-2"></div>

      <p-iftalabel>
        <input pInputText id="email" formControlName="email" autocomplete="off" class="uniform-input"/>
        <label for="email">Email *</label>
        <small *ngIf="userForm.get('email')?.touched && userForm.get('email')?.invalid" class="text-red-500">
          Email invalide ou requis.
        </small>
      </p-iftalabel>
      <div class="h-2"></div>

      <p-iftalabel>
        <p-select [options]="roles" id="role" optionLabel="label" optionValue="value" placeholder="Sélectionner un rôle" class="w-full md:w-56" formControlName="role" class="uniform-input"/>
        <label for="role">Rôle *</label>
        <small *ngIf="userForm.get('role')?.touched && userForm.get('role')?.invalid" class="text-red-500">
          Le rôle est requis.
        </small>
      </p-iftalabel>
      <div class="h-2"></div>

      <p-iftalabel>
        <p-select [options]="services" [filter]="true" id="service" optionLabel="name" optionValue="id" placeholder="Sélectionner un service" class="w-full md:w-56" formControlName="service" class="uniform-input"/>
        <label for="service">Service</label>
      </p-iftalabel>
      <div class="h-2"></div>

      <p-iftalabel>
        <p-select [options]="speciality" [filter]="true" id="speciality" optionLabel="name" optionValue="id" placeholder="Sélectionner une compétence" class="w-full md:w-56" formControlName="speciality" class="uniform-input"/>
        <label for="service">Compétence</label>
      </p-iftalabel>
      <div class="h-2"></div>

      <p-iftalabel *ngIf="!isEditMode">
        <p-password [toggleMask]="true" autocomplete="off" id="password" formControlName="password" class="w-full uniform-input" [style]="{ 'width': '100%' }" [inputStyle]="{ width: '100%' }"/>
        <label for="password">Mot de passe *</label>
        <small *ngIf="userForm.get('password')?.touched && userForm.get('password')?.invalid" class="text-red-500">
          Mot de passe requis (min. 8 caractères).
        </small>
      </p-iftalabel>
      <div class="h-2" *ngIf="!isEditMode"></div>

      <p-button [label]="isEditMode ? 'Mettre à jour' : 'Ajouter un utilisateur'" severity="contrast" (click)="onSubmit()" [disabled]="loading() || userForm.invalid" />
    </div>
  </p-drawer>

  <div class="table-container overflow-x-auto" style="border-radius: 0.75rem;">
    <p-table [value]="filteredUsers" [paginator]="true" [rows]="rows" [totalRecords]="totalRecords" [lazy]="false" (onPage)="onPageChange($event)" [tableStyle]="{ 'min-width': '100%' }" responsiveLayout="scroll" class="w-full">
      <ng-template pTemplate="header">
        <tr>
          <th style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Nom</th>
          <th style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Prénom</th>
          <th style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Adresse Mail</th>
          <th style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Téléphone</th>
          <th style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Rôle</th>
          <th style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Service</th>
          <th style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Compétence</th>
          <th style="background-color: #e5e7eb; padding: 1rem; font-weight: 600; color: #374151">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-user>
        <tr>
          <td>{{ user.first_name }}</td>
          <td>{{ user.last_name }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.phoneNumber }}</td>
          <td>{{ user.displayRole }}</td>
          <td>{{ user.serviceName || 'Aucun' }}</td>
          <td>{{ user.specialityName || 'Aucune' }}</td>
          <td class="space-x-3">
            <i class="pi pi-pencil cursor-pointer text-blue-500 hover:text-blue-700" (click)="editUser(user)"></i>
            <i class="pi pi-trash cursor-pointer text-red-500 hover:text-red-700" (click)="confirmDelete(user)"></i>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-confirmDialog></p-confirmDialog>
</div>